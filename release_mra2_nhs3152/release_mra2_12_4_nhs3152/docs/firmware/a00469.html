<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NHS31xx SW API: diag: Diagnostics module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nxp-logo_small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NHS31xx SW API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('a00469.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">Modules</a> &#124;
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">diag: Diagnostics module<div class="ingroups"><a class="el" href="a00425.html">Modules</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>This module collects basic information about the behavior of the IC and stores it in EEPROM. The purpose is to fetch the stored data later for post-mortem analysis to help identifying an issue or to use it for performance monitoring.</p>
<p>Five statistics are gathered:</p><ul>
<li>Number of cold boots</li>
<li>Number of wake-ups</li>
<li>Deep Power down time</li>
<li>Active time</li>
<li>Number of NFC taps</li>
</ul>
<dl class="section user"><dt>Number of cold boots</dt><dd>The number of times a cold boot was detected is counted. A cold boot is generated when leaving the Power-off mode, when the RESETN pin has been toggled, or when the watchdog timer expires.</dd></dl>
<dl class="section user"><dt>Number of wake-ups</dt><dd>The number of times a wake-up was detected is counted. A wake-up is generated when leaving the Deep power down mode. The reason of the wakeup - due to NFC, RTC timeout or WAKEUP pin toggle - is not tracked.</dd></dl>
<dl class="section user"><dt>Deep power down time</dt><dd>The Deep power down time accumulates the time spent in Deep power down mode.<ul>
<li>The time is reported in seconds.</li>
<li>The ARM RTC up counter is used to track the time.</li>
<li>Each time the Deep power down mode is entered, an accuracy loss of up to 1 second can occur.</li>
<li>Upon a power failure, the total last time spent while in Deep down mode is lost and untracked.</li>
</ul>
</dd></dl>
<dl class="section user"><dt>Active time</dt><dd>The active time accumulates the time spent in Active, Sleep and Deep sleep modes. Time spent while in Deep Power Down or Power-off mode is excluded.<ul>
<li>The time is reported in seconds.</li>
<li>The ARM RTC up counter is used to track the time.</li>
<li>The System up time will remain accurate even when the RTC timer is reset or reconfigured.</li>
<li>Upon a power failure, the total last time spent while Active (or Sleep or Deep sleep mode) is lost and untracked.</li>
</ul>
</dd></dl>
<dl class="section note"><dt>Note</dt><dd>For a typical logging application, where the time spent in Active, Sleep and Deep sleep mode is in the order of 50 - 100 ms, the reported time here will only differ from 0 due to the time spent inside an NFC field.</dd></dl>
<dl class="section user"><dt>Number of NFC taps</dt><dd>The number of times the tag was selected for NFC communication by a tag reader.<ul>
<li>It is not tracked how long the tag was selected.</li>
<li>It is not tracked whether communication - NFC reads or writes - actually occurred.</li>
<li>Some tag readers enable and disable the NFC field multiple times as part of a single tap (I'm mainly looking at Android phones here). This is not an issue when waking up from Deep power down or Power-off, but may cause to false positives when an NFC field is applied while the IC was already in Active mode. Therefore, subsequent NFC field detections are only counted when the RTC up counter value has changed.</li>
</ul>
</dd></dl>
<dl class="section user"><dt>Diversity</dt><dd>This module supports a single diversity <a class="el" href="a00470.html#gab88258e77ce4f13862d53b9cdd6a9aaa">ENABLE_DIAG_MODULE</a>. See <a class="el" href="a00470.html">Diversity settings</a>.</dd></dl>
<dl class="section user"><dt>Implementation</dt><dd>To be able to track the above statistics, it relies on the <a class="el" href="a00481.html">startup: Startup and exception handlers</a> startup module, the <a class="el" href="a00458.html">pmu: Power Management Unit driver</a> PMU driver and the <a class="el" href="a00459.html">rtc: Real-Time Clock driver</a> RC driver to call its API when appropriate. The interrupt vector table in the startup module is also modified to intercept the appropriate interrupts, after which they are redirected to the application again using the normally expected weak interrupt handler.</dd></dl>
<p>The total implementation - here in this module, and also the accommodating changes made in the startup module, the PMU driver and the RTC driver - can be enabled or disabled without requiring any change in the board library or the application layer. </p><dl class="section see"><dt>See also</dt><dd><a class="el" href="a00470.html#gab88258e77ce4f13862d53b9cdd6a9aaa">ENABLE_DIAG_MODULE</a></dd></dl>
<p>Care is taken to flush all data to EEPROM in a timely way, without imposing a burden to the system.</p>
<dl class="section warning"><dt>Warning</dt><dd>The diagnostics module assumes the behavior needs only be tracked when battery-powered. When powered passively, i.e. through the NFC harvested energy, the power is lost whenever the tag is removed from the tag reader. Statistics will not be updated in, as no intermediate writes to EEPROM of the gathered statistics are performed. This only happens the the application firmware explicitly decides to enter deep power down or power-off mode.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>The diagnostics module assumes that all write accesses to the RTC and the PMU are done using the corresponding SW drivers. If these registers are accessed directly, the data gathered from the diagnostics module become useless. </dd></dl>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="groups"></a>
Modules</h2></td></tr>
<tr class="memitem:a00470"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00470.html">Diversity settings</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:a00690"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00469.html#a00690">DIAG_DATA_T</a></td></tr>
<tr class="separator:a00690"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga1ff389e1ee532a30ade74e9b5868dcfe"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00469.html#ga1ff389e1ee532a30ade74e9b5868dcfe">Diag_Init</a> (void)</td></tr>
<tr class="separator:ga1ff389e1ee532a30ade74e9b5868dcfe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga1a693b887d5171883beda00b1882b5f6"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00469.html#ga1a693b887d5171883beda00b1882b5f6">Diag_DeInit</a> (void)</td></tr>
<tr class="separator:ga1a693b887d5171883beda00b1882b5f6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gad66162e88b3cb17ec9e28d154605b13d"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00469.html#gad66162e88b3cb17ec9e28d154605b13d">Diag_TrackRtcUpdate</a> (int new)</td></tr>
<tr class="separator:gad66162e88b3cb17ec9e28d154605b13d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gac3284f14b11b855bdac2f8d1ccb8c0a6"><td class="memItemLeft" align="right" valign="top">const <a class="el" href="a00469.html#a00690">DIAG_DATA_T</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00469.html#gac3284f14b11b855bdac2f8d1ccb8c0a6">Diag_Get</a> (void)</td></tr>
<tr class="separator:gac3284f14b11b855bdac2f8d1ccb8c0a6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gadb3b63e2ba336be8e6317e0eb2a3c96f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00469.html#gadb3b63e2ba336be8e6317e0eb2a3c96f">Diag_NFC_IRQHandler</a> (void)</td></tr>
<tr class="separator:gadb3b63e2ba336be8e6317e0eb2a3c96f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<hr/><h2 class="groupheader">Data Structure Documentation</h2>
<a name="a00690" id="a00690"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a00690">&#9670;&nbsp;</a></span>DIAG_DATA_T</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct DIAG_DATA_T</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock"><p>Statistics data, retrieved by <a class="el" href="a00469.html#gac3284f14b11b855bdac2f8d1ccb8c0a6">Diag_Get</a> </p>
</div><table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a id="a66e7a2f2bf15ca01db10dd5a672255e5"></a>uint32_t</td>
<td class="fieldname">
coldBootCount</td>
<td class="fielddoc">
<p>Total number of cold boots. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a835ebaba173e43749be471dca1ce540c"></a>uint32_t</td>
<td class="fieldname">
wakeUpCount</td>
<td class="fielddoc">
<p>Total number of wake-ups. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a5117167aa0885dede22c52c117680d21"></a>int32_t</td>
<td class="fieldname">
activeTime</td>
<td class="fielddoc">
<p>Accumulated Active, Sleep and Deep Sleep time in seconds. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="adf7d1fb0dafbae57d57d63c35859ad41"></a>int32_t</td>
<td class="fieldname">
deepPowerDownTime</td>
<td class="fielddoc">
<p>Accumulated Deep power down time in seconds. </p>
</td></tr>
<tr><td class="fieldtype">
<a id="a9bca56f14ae5350956757ff0bb40e349"></a>uint32_t</td>
<td class="fieldname">
nfcTapCount</td>
<td class="fielddoc">
<p>Total number of NFC select states. </p>
</td></tr>
</table>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ga1ff389e1ee532a30ade74e9b5868dcfe"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga1ff389e1ee532a30ade74e9b5868dcfe">&#9670;&nbsp;</a></span>Diag_Init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Diag_Init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>This function must be the first function to call in this module after leaving deep power down mode or power-off mode. </p><dl class="section note"><dt>Note</dt><dd>This function will not use any variable from the BSS or DATA section, so is safe to be called as early as any moment while <a class="el" href="a00481.html#gabf9682a2f14dd5eada5712b220db2e81">Startup_VarInit</a> is executed. It is best called in that function.</dd></dl>
<ul>
<li>Loads the statistics from EEPROM to SRAM</li>
<li>Updates the statistics: cause of chip startup and deep power down duration if appropriate.</li>
</ul>
<dl class="section post"><dt>Postcondition</dt><dd>EEPROM is powered and initialized. </dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="a00481.html#gabf9682a2f14dd5eada5712b220db2e81">Startup_VarInit</a> </dd></dl>

</div>
</div>
<a id="ga1a693b887d5171883beda00b1882b5f6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga1a693b887d5171883beda00b1882b5f6">&#9670;&nbsp;</a></span>Diag_DeInit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Diag_DeInit </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>This function must be the last function to call in this module before entering deep power down mode or power-off mode. If not called, the statistics gathered and changed during the last active period (Active, sleep and deep sleep modes combined - are lost. </p><dl class="section note"><dt>Note</dt><dd>It is best called from <a class="el" href="a00458.html#ga1af1ed037e3824d314f7a01649cf2800">Chip_PMU_PowerMode_EnterDeepPowerDown</a> and <a class="el" href="a00458.html#ga49d6eeaf641dec113e934dac07146390">Chip_PMU_Switch_OpenVDDBat</a>. </dd></dl>
<dl class="section post"><dt>Postcondition</dt><dd>EEPROM is powered and initialized. </dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="a00458.html#ga1af1ed037e3824d314f7a01649cf2800">Chip_PMU_PowerMode_EnterDeepPowerDown</a> </dd>
<dd>
<a class="el" href="a00458.html#ga49d6eeaf641dec113e934dac07146390">Chip_PMU_Switch_OpenVDDBat</a> </dd></dl>

</div>
</div>
<a id="gad66162e88b3cb17ec9e28d154605b13d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gad66162e88b3cb17ec9e28d154605b13d">&#9670;&nbsp;</a></span>Diag_TrackRtcUpdate()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Diag_TrackRtcUpdate </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>new</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Must be called by the RTC driver when the RTC up counter is changed on request of the application. This allows to track the accumulated system up time. </p><dl class="section pre"><dt>Precondition</dt><dd>Must be called before the update is executed. </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">new</td><td>: the new RTC up-counter value </td></tr>
  </table>
  </dd>
</dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="a00459.html#gacc9b42f869a58aa0c5072677543c0d03">Chip_RTC_Time_SetValue</a> </dd></dl>

</div>
</div>
<a id="gac3284f14b11b855bdac2f8d1ccb8c0a6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gac3284f14b11b855bdac2f8d1ccb8c0a6">&#9670;&nbsp;</a></span>Diag_Get()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const <a class="el" href="a00469.html#a00690">DIAG_DATA_T</a>* Diag_Get </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="section return"><dt>Returns</dt><dd>a pointer to the latest statistics in SRAM. </dd></dl>

</div>
</div>
<a id="gadb3b63e2ba336be8e6317e0eb2a3c96f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gadb3b63e2ba336be8e6317e0eb2a3c96f">&#9670;&nbsp;</a></span>Diag_NFC_IRQHandler()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Diag_NFC_IRQHandler </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Interrupt handler for the NFC Read/Write Interrupt hook. To be used instead of the application defined WEAK-defined interrupt <a class="el" href="a00481.html#gac1c3452d4422030154067f1cc26279a3">NFC_IRQHandler</a> </p><dl class="section pre"><dt>Precondition</dt><dd>must be used by startup.c only </dd></dl>
<dl class="section see"><dt>See also</dt><dd>g_pfnVectors </dd></dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Oct 20 2020 08:24:34 for NHS31xx SW API by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
