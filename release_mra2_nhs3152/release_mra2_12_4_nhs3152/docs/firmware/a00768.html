<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NHS31xx SW API: SW Debug Considerations</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nxp-logo_small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NHS31xx SW API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('a00768.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">SW Debug Considerations </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Although the NHS31xx IC has full debugging capabilities, there are a number of peculiarities to be reckoned with. These items have been grouped here.</p>
<h1><a class="anchor" id="debugconsideration_swd"></a>
SWD</h1>
<dl class="section user"><dt>Default setup</dt><dd>After boot, by default - i.e. if no code read protection is enabled - the SWD pins (PIO 10 and 11) are configured for ARM Single-wire debug (<code>FUNC2</code>): see <em>chapter 7 Pinning information, table 3 Pin allocation</em> of the HVQFN24 package in the Objective Data Sheet and <em>chapter 26 Input/Output configuration, sections 26.3.11 PIO0_10 and 26.3.12 PIO0_11</em> in the HW User Manual.</dd></dl>
<dl class="section user"><dt>GPIO </dt><dd>These pins can be reconfigured using <a class="el" href="a00456.html#ga426cc484a31e59241f87215e5e452c56">Chip_IOCON_SetPinConfig</a> but this will break any existing debugging session, and prevent establishing a new one. When it is necessary to re-assign the purpose of these pins, it is therefore recommended to ensure there is a way to force a new debug session: e.g. by ensuring that after a reset these pins are not touched for a couple of seconds, or by using <a class="el" href="a00477.html">msg: Message Handler</a> for communication and enabling the message <a class="el" href="a00477.html#ggade7075e3d56378af75d2c2dd4110ddd7a9bd9f498b8f9a5b955f3c7005fa36e17">MSG_ID_PREPAREDEBUG</a> via <a class="el" href="a00478.html#gaeebc1399ea7700bf439d91ed6b1d2ecc">MSG_ENABLE_PREPAREDEBUG</a>.</dd></dl>
<h1><a class="anchor" id="debugconsideration_lowpowermodes"></a>
Low Power Modes</h1>
<dl class="section user"><dt>Power-off &amp; Deep power down </dt><dd>Another way to 'brick' a device is to go to the <a class="el" href="a00458.html#ga49d6eeaf641dec113e934dac07146390">Power-off mode</a> or the <a class="el" href="a00458.html#ga1af1ed037e3824d314f7a01649cf2800">Deep power down mode</a>. When using these modes, a SW error may be enough to prematurely decide to go into one of these modes. In both mentioned modes the SWD lines are not accessible. Existing debug sessions will yield errors; new debug sessions can not be created. One precaution to take is to wait for a number of seconds before going to such a mode using <a class="el" href="a00434.html#ga30f8dffbc3aff9e560b8609c6ca80c13">Chip_Clock_System_BusyWait_ms</a>. New firmware can then always be flashed by toggling the <code>RESETN</code> pin just before the IC is targeted for a debug session. In case a debug build is used, it is possible to introduce a 500ms delay by approaching an NFC field before entering Deep Power Down. This functionality is embedded in the <a class="el" href="a00458.html#ga1af1ed037e3824d314f7a01649cf2800">Chip_PMU_PowerMode_EnterDeepPowerDown</a> function and allows starting a debug session in ICs that would otherwise never accept a debug connection anymore.<br />
 Another possibility is to ensure the ARM remains Active or in <a class="el" href="a00458.html#gaf9474d0c37f1179ebe0edf523883452c">Sleep mode</a> while an NFC field is present. <br />
 A third way is to configure one unused GPIO as input with a pull-up and to wait indefinitely just before entering these modes as long as the pin is low. You can then be sure to be able to create a debug session and to flash a new program by putting the NHS31xx IC below an NFC-enabled phone. </dd></dl>
<dl class="section note"><dt>Note</dt><dd>A mistake easily made when attempting to establish a debug session is to forget to ensure the IC is not in power-off mode: inserting a battery will not wake up the IC. </dd>
<dd>
Connecting the LPC-Link2 board with the demo PCB starts the IC when it was in power-off mode, and wakes up the IC when it was in deep power down mode. </dd>
<dd>
Be careful when placing a jumper over JP2 on the LPC-Link2 board as disconnecting the battery via SW - i.e. entering power-off mode using <a class="el" href="a00458.html#ga49d6eeaf641dec113e934dac07146390">Chip_PMU_Switch_OpenVDDBat</a> - will put the IC in an undetermined state: the ALON domain will remain powered and full power-off is only achieved after disconnecting the SWD cable or removing the jumper over JP2. Do <b>not</b> attempt to continue debugging, as nothing is guaranteed anymore and any behavior may be provoked. As a precaution, add an infinite wait loop <code>for</code>(;;); or similar after a call to <a class="el" href="a00458.html#ga49d6eeaf641dec113e934dac07146390">Chip_PMU_Switch_OpenVDDBat</a>.</dd></dl>
<h1><a class="anchor" id="debugconsideration_development"></a>
Development</h1>
<dl class="section user"><dt>Development strategy</dt><dd>Because of the difficulties with debugging while using the <a class="el" href="a00458.html#ga49d6eeaf641dec113e934dac07146390">Power-off mode</a> or the <a class="el" href="a00458.html#ga1af1ed037e3824d314f7a01649cf2800">Deep power down mode</a> it may be worthwhile to avoid these states as long as possible during the development traject: try to split the application's responsibilities in separate chunks where these power states are required; implement those separately and only after that merge and tie them all together. This may also be very helpful for your testing strategy.</dd></dl>
<dl class="section user"><dt>Examples</dt><dd>You can check these different provisions in the implementation of the Temperature logger demo - <em>app_demo_dp_tlogger</em> and the Therapy adherence demo - <em>app_demo_dp_tadherence</em>.</dd></dl>
<p><a class="anchor" id="crp_crp2crp3_anchor"></a> </p><dl class="section user"><dt>CRP</dt><dd>The NHS31xx ICs support Code Read Protection (CRP). This is a mechanism to add a level of protection: at startup, when the bootloader runs, a specific location in FLASH memory is read. Depending on the value read, the bootloader can decide to keep SWD access disabled, or to erase the entire FLASH. <br />
 The CRP modes supported by the NHS31xx IC are <code>CRP_NO_CRP</code>, <code>CRP_CRP2</code> and <code>CRP_CRP3_CONSUME_PART</code>. The CRP magic word has to be stored in Flash address <code>0x000002FC</code>.</dd></dl>
<ul>
<li><code>CRP_NO_CRP</code> (value: <code>0xFFFFFFFF</code>) <br />
 CRP is disabled in this mode and hence SWD will be enabled when the bootloader has finished.</li>
<li><code>CRP_CRP2</code> (value: <code>0x87654321</code>) <br />
 This will disable SWD access. The application firmware can decide to re-enable SWD access. In addition, the WAKE-UP pin is checked and if it is pulled low, the entire FLASH memory is erased.</li>
<li><code>CRP_CRP3_CONSUME_PART</code> (value: <code>0x43218765</code>) <br />
 This will disable SWD access. The application firmware can decide to re-enable SWD access.</li>
</ul>
<dl class="section user"><dt>Building applications with CRP</dt><dd>The CRP_NO_CRP, CRP_CRP2 and CRP_CRP3_CONSUME_PART macros are defined in the crp.h header file which is part of the LPCXpresso tool directory. All applications have to mandatorily define the macro CRP_WORD to one of the above values in the crp.c file. This file gets automatically generated on creating a new project using the LPCXpresso wizard. All applications delivered by the SDK have the CRP feature turned off. When your application starts to use the code read protection feature - using value <code>CRP_CRP2</code> or <code>CRP_CRP3_CONSUME_PART</code> - the SWD pins are configured as input and for GPIO usage when your application gets control. You can then still allow debugging by explicitly configuring the pins using the below code included in your application firmware: <div class="fragment"><div class="line"><a class="code" href="a00456.html#ga426cc484a31e59241f87215e5e452c56">Chip_IOCON_SetPinConfig</a>(<a class="code" href="a00433.html#ga9f6e80f81c74d0d95a79e92ed670f1b3">NSS_IOCON</a>, <a class="code" href="a00456.html#gga42905d0e658c71f0b5a26aac076744cca7f69b3fd8bcff295ab6a59b0c9eb9260">IOCON_PIO0_10</a>, <a class="code" href="a00456.html#gad83d3c725d3c188f3f907630580b48e0">IOCON_FUNC_2</a>);</div><div class="line"><a class="code" href="a00456.html#ga426cc484a31e59241f87215e5e452c56">Chip_IOCON_SetPinConfig</a>(<a class="code" href="a00433.html#ga9f6e80f81c74d0d95a79e92ed670f1b3">NSS_IOCON</a>, <a class="code" href="a00456.html#gga42905d0e658c71f0b5a26aac076744ccafcfab60ac8822ea7b2a6dc934c6baf32">IOCON_PIO0_11</a>, <a class="code" href="a00456.html#gad83d3c725d3c188f3f907630580b48e0">IOCON_FUNC_2</a>);</div></div><!-- fragment --> </dd></dl>
<dl class="section note"><dt>Note</dt><dd>Using CRP mode <code>CRP_CRP3_CONSUME_PART</code> while still developing - and debugging - your code only makes a developer's life even harder. Only use this mode for your final firmware, and in that final firmware, also ensure the SWD pins are never reconfigured as in the code above, or the extra security gained from this will be lost. </dd>
<dd>
When the SWD pins are multiplexed and to be used both to allow a debugging session and for sensing, it is easy to 'brick' your IC. In that case, enabling CRP mode <code>CRP_CRP2</code> makes sense, as it provides another way to 'unbrick' your IC and development board: pull and keep <code>PIO0_1</code> low, then reset the IC: the bootloader will then ensure all writeable FLASH sectors (<a class="el" href="a00433.html#ga1e4e3129a8b1244062db083955508372">FLASH_NR_OF_RW_SECTORS</a>) are erased. <br />
 All code and data in FLASH is lost, but your IC can be reprogrammed and used again. <br />
 When considering this latter approach, be aware that after a reset (hard reset or when leaving Deep Power Down) the pulls are removed from all pins. They are re-configured by calling <a class="el" href="a00430.html#gae8d2d761b984f48c3dbb27dd32a8c119">Board_Init</a>, i.e. em after the bootloader has run. To prevent unwanted full flash erasures, you must add an external weak pull-up on <code>PIO0_1</code>.</dd></dl>
<h1><a class="anchor" id="debugconsideration_debugconnection"></a>
Debug connection</h1>
<dl class="section user"><dt>Breakpoints</dt><dd>While debugging with breakpoints set these breakpoints remain when the debug session is forcefully broken (i.e. when the SWD cable is disconnected before the debug session is properly terminated in the LPCXpresso IDE. The ARM application will then be halted perpetually when it is hit. You can then try to establish a new debug session without reflashing the program and resetting the program counter PC and stack pointer SP (see the <em>Attach only</em> option in your Debug configuration) and continue execution. If that is not possible, a hard reset is the only option left.</dd></dl>
<dl class="section user"><dt>Error messages</dt><dd><ul>
<li>When trying to establish a debug session with an IC still in power-off mode, the LPCXpresso IDE will pop up an error dialog with the message <div class="fragment"><div class="line">Target reported errors</div><div class="line">Reason: 02: Failed on connect Could not connect to core. 31: No connection to emulator device.</div></div><!-- fragment --> This error indicates everything seems to be fine with the LPC-Link2 board but the NHS31xx IC could not be reached. Close the dialog, and restart using one of these options:<ul>
<li>timely toggle the <code>RESETN</code> pin to wake up the IC - press and release the Reset button on a demo PCB,</li>
<li>hold a phone close with the NFC field enabled to power the NFC controller which will wake up the IC.</li>
</ul>
</li>
<li>When while debugging using the LPCXpresso IDE the debug session is broken - be it by unplugging the SWD cable or by reconfiguring the SWD pins - an error dialog will pop up with the message <div class="fragment"><div class="line">Target reported errors</div><div class="line">Reason: 16: Target error from status-poll: Ee(FF). Undocumented error.</div></div><!-- fragment --> Close the dialog, terminate the ongoing session, and restart.</li>
<li>Even after an error occurred the LPCXpresso IDE will never automatically terminate a now defunct debug session. Trying to start a new session before terminating the old one will yield the error message <div class="fragment"><div class="line">No debug targets available.</div><div class="line">Reason: All SWD target are currently connected to other debug sessions.</div></div><!-- fragment --> Close the dialog, terminate the ongoing session, and restart.</li>
</ul>
</dd></dl>
<h1><a class="anchor" id="debugconsideration_stacksize"></a>
Stack size</h1>
<p>The NHS31xx IC has 8 KB of SRAM memory, of which 8716 bytes are available for the firmware. When this is not enough, the stack memory used will end up overwriting static data. Worst case the program will not crash but behave odd and produce incorrect results.</p>
<dl class="section note"><dt>Note</dt><dd>For more background, visit e.g. <a href="https://community.arm.com/developer/ip-products/processors/b/processors-ip-blog/posts/how-much-stack-memory-do-i-need-for-my-arm-cortex--m-applications">this blog post on the ARM community</a>.</dd></dl>
<p>It is not possible to track the stack usage live while debugging. You can instrument the project to retrieve stack size information. <br />
 </p><dl class="section user"><dt>During compilation</dt><dd>Add the gcc compiler option <code>-fstack-usage</code> to have a <code></code>.su file generated for each compilation unit (C file) within the folder of the used build configuration. These files can then be aggregated and checked for high numbers or unexpected changes between two points in time.</dd></dl>
<dl class="section user"><dt>During execution</dt><dd>You can surround all or part of your program with non-production code.<ul>
<li>First write a pattern into unused SRAM.</li>
<li>Next execute the block you want to learn the stack usage from.</li>
<li>Finally check how much of the pattern is altered.</li>
</ul>
For the NHS31xx ICs, you can use these blocks of code. <br />
<ul>
<li>Before the block of code to check: <div class="fragment"><div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="keywordtype">int</span> _pvHeapStart; <span class="comment">/* Generated by the linker. Indicates lowest unused SRAM address at start of main. */</span></div><div class="line"><span class="keywordtype">char</span> top;</div><div class="line"><span class="comment">/* Fill the currently unused SRAM with an identical non-trivial pattern. */</span></div><div class="line">memset((<span class="keywordtype">void</span> *)&amp;_pvHeapStart, 0xA5, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)&amp;top - (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)&amp;_pvHeapStart - 32);</div></div><!-- fragment --></li>
<li>After the block of code to check: <div class="fragment"><div class="line"><span class="comment">/* Check how much stack has been used. */</span></div><div class="line"><span class="keywordtype">char</span> * b = &amp;top - 32;</div><div class="line"><span class="keywordflow">do</span> {</div><div class="line">    b--;</div><div class="line">}</div><div class="line"><span class="keywordflow">while</span> ((b &gt;= (<span class="keywordtype">char</span> *)&amp;_pvHeapStart) &amp;&amp; (b != 0xA5));</div><div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="keywordtype">int</span> __top_RAM; <span class="comment">/* Generated by the linker. The first value above the initial stack position. */</span></div><div class="line"><span class="keywordtype">int</span> used = (int)&amp;__top_RAM - (<span class="keywordtype">int</span>)b;</div></div><!-- fragment --></li>
</ul>
</dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Oct 20 2020 08:24:33 for NHS31xx SW API by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
