<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NHS31xx SW API: tlogger: Temperature Logger demo application firmware</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nxp-logo_small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NHS31xx SW API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('a00418.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">Modules</a>  </div>
  <div class="headertitle">
<div class="title">tlogger: Temperature Logger demo application firmware<div class="ingroups"><a class="el" href="a00424.html">Applications</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>The Temperature Logger demo application firmware demonstrates the value proposition around the Temperature Logger use case. This application, together with a label or a demo PCB and a matching tag reader application on Android, iOS, macOS or Windows, can serve as a starting point for application and APP developers to develop a full-blown solution for NFC-enabled temperature logging.</p>
<dl class="section user"><dt>Introduction</dt><dd>This demo application is designed to run on an NHS31xx IC mounted on a NHS3100 temperature logger Demo PCB - which can be ordered directly at nxp.com/NTAGSMARTSENSOR. <br />
 The application firmware is built on top of the SDK offering: it uses the APIs exposed by the chip and board libraries, and it makes use of the available modules as much as possible.</dd></dl>
<dl class="section user"><dt>Getting started and how to operate</dt><dd>With the firmware image loaded in an NHS31xx IC, all you need next is any NFC reader. Best demo results are achieved when using an NFC-enabled Android smartphone, or an iPhone 7 or higher. In that case the <em>NHS3100 Temperature Logger</em> can be used, which is available in the Google Play Store or the Apple App store. All configuration and data retrieval can be done via the APP (note that iOS only supports NDEF reading, nor writing, so setting a configuration requires either an Android phone or the use of the macOS application). Without the APP, on an Android smartphone, only status information can be retrieved in the form of a textual message that pops up on the screen. This textual retrieval is supported out of the box on Android, and can be done with any freely available generic NFC APP on all other platforms.</dd></dl>
<p>It is also possible to hook up an NFC reader via a USB port to your PC, and to use a Python script or a full blown application - check the NHS3100 Temperature Logger application for macOS - to communicate with the tlogger firmware image.</p>
<dl class="section user"><dt>ARM application overview</dt><dd><ul>
<li>The execution flow of the application is described in the following diagram: <b>TODO</b> </li>
<li>The block decomposition of the application is clarified in the following block diagram: <b>TODO</b> </li>
<li>To enable communication of data between the tag - containing the NHS3100 IC - and a tag reader - whether it is a smartphone or a PC - the NFC controller is used to read and write NDEF messages containing MIME records. The full communication protocol is outlined below.</li>
</ul>
<a class="anchor" id="app_demo_tlogger_communication_protocol_anchor"></a></dd></dl>
<dl class="section user"><dt>Communication protocol</dt><dd><ul>
<li>For maximum compatibility, the use of NDEF messages is required: iOS 11 running on an iPhone 7 or higher only allows reading of NDEF messages. The application code relies on the NDEFT2T module to ensure that:<ul>
<li>all data is correctly encapsulated in a MIME record inside an NDEFT2T message <br />
 when sending data from the tag to the tag reader; and vice versa,</li>
<li>to extract the payload bytes in a MIME record inside an NDEFT2T message <br />
 when receiving data from the tag reader.</li>
</ul>
</li>
<li>The payload bytes in a MIME record are in turn formatted according to the rules stipulated by the <em>msg</em> module. Detailed information about these rules can be found with <a class="el" href="a00477.html">msg: Message Handler</a>. The <em>msg</em> module allows for the inclusion of application specific messages, which the application uses to allow getting and retrieving the configuration details, and the gathered data (temperature measurements). The details about the application specific messages are captured in the protocol submodule <a class="el" href="a00491.html">'tlogger' app.spec. messages</a>.</li>
<li>The full communication flow from tag to tag reader is largely inline with the definitions and workflow outlined in the <em>msg</em> module: <br />
<ul>
<li>(A,B) The tag reader sends a command, which is wrapped in a message containing a single MIME record,</li>
<li>(C) by writing into the NFC memory. The NFC controller notifies the ARM Cortex M0+,</li>
<li>(D) after which the application code reads out the command and extracts the MIME payload - using the NDEFT2T module - and feeds it to the <em>msg</em> module,</li>
<li>(E) which then calls the registered handler function. The end result of handling is the generation of a response,</li>
<li>(D) which is again wrapped in a message containing a single MIME record,</li>
<li>(C) and finally copied to the NFC memory - thereby overwriting the command that was originally written by the tag reader.</li>
<li>(B) The tag reader reads out the same NFC memory again, extracts the MIME payload,</li>
<li>(A) and interprets the response bytes to update his logs and GUI.</li>
</ul>
<br />
<div class="mscgraph">
<img src="msc_inline_mscgraph_2.png" alt="msc_inline_mscgraph_2" border="0" usemap="#msc_inline_mscgraph_2.map"/>
<map name="msc_inline_mscgraph_2.map" id="msc_inline_mscgraph_2.map"><area href="a00477.html#msg_anchor_protocol" shape="rect" coords="130,58,254,71" alt=""/>
<area href="a00477.html#msg_anchor_protocol" shape="rect" coords="100,71,285,84" alt=""/>
<area href="a00477.html#msg_anchor_protocol" shape="rect" coords="709,250,828,263" alt=""/>
<area href="a00477.html#msg_anchor_protocol" shape="rect" coords="678,263,859,276" alt=""/>
<area href="a00477.html#msg_anchor_protocol" shape="rect" coords="133,346,252,359" alt=""/>
<area href="a00477.html#msg_anchor_protocol" shape="rect" coords="102,359,283,372" alt=""/>
</map>
</div>
 <br />
</li>
<li>There are two deviations to the otherwise strict command - response way of communication. The first occurs at the startup of the IC: the tag will then create a multi-record message containing the responses to a few general commands, which the tag assumes any tag reader will want to know. For demo purposes, to demonstrate the Android OS is perfectly capable of decoding our standards compliant NDEFT2T messages, one or more text records are also included, which describe in English text form the current state of the IC and the temperature monitoring. The text records are ignored by the Android APP, but are used by the iOS APP to display the current status. The Android and iOS APPs currently both expect a few specific MIME records to be present: they do not look at the type of the NFC controller being connected to, but read out the initial message available in the NFC memory, and decide whether communication is possible, based on the responses with message id <a class="el" href="a00477.html#ggade7075e3d56378af75d2c2dd4110ddd7acf2027afe00dc0d127e562519f67fc5e">MSG_ID_GETVERSION</a> and <a class="el" href="a00491.html#ggaaac9c56961755fb862e21432c9425640a2b3cd31ed54361a1eaec43b49d537058">APP_MSG_ID_GETCONFIG</a> (in that order) they can extract from that. Of course, all other MIME records present are also parsed and taken into account.<br />
 Note that this approach also poses a risk: there is no guideline or standard enforcing a minimal delay between connecting with a tag and reading out the NFC memory. In theory, this means that a tag reader can read out whatever is present immediately after successfully establishing a connection. The time between detecting an NFC field - after which the IC will start up - and the copying of the initial multi-record message may be too short: the application firmware may be too late to provide the expected information, which causes the APP to conclude an alien tag is connected to, and communication is not possible. This is the reason why at startup, in <a class="el" href="a00481.html#ga516ff8924be921fa3a1bb7754b1f5734">ResetISR</a>, the system clock frequency is upped to 2MHz.</li>
<li>The second deviation is added to enable as much functionality as possible of the temperature logger demo for iOS users, where NFC writing is not possible. All NFC interrupts are handled by the NDEFT2T module: it can use it to<ul>
<li>correctly write NDEF messages - even when spurious writes occur by the tag reader</li>
<li>correctly read NDEF messages - preventing simultaneous reading by the tag and writing by the tag writer which would otherwise lead to race conditions</li>
<li>correctly detect when the tag reader has finished reading the NDEF message that is available in the NFC memory.</li>
</ul>
Due to slightly different implementations of the tag readers' NFC stack libraries on different systems and OS versions, it is not possible to simultaneously and correctly take care for all three cases listed above. At startup, after writing the initial NDEF message. It enables an 'automatic mode' - using <a class="el" href="a00479.html#ga7534ae047d7e38cb6d59d848753df6eb">NDEFT2T_EnableAutomaticMode</a> - where the application uses the 'message read' notifications as a trigger to play a script: each 'message read' notification triggers the creation of a new command, generated in the application code in the <code>GenerateNextAutomaticCommand</code>, which serves as a replacement of a real NDEF message write of the tag reader. As long as the tag reader is not writing to the NFC memory, the tag assumes it knows which responses the tag reader wants to fetch from the tag, and continually updates the NFC memory with new responses. This approach has two advantages:<ul>
<li>Using an iOS APP, all data measurements can be read out.</li>
<li>All data measurements can be read out slightly faster than by a continual command - response exchanges.</li>
</ul>
It also has one big disadvantage:<ul>
<li>The tag reader APP has no control over what can be read out.</li>
</ul>
The application seamlessly switches from this 'automatic mode' to conventional command - response exchanges when the tag reader starts writing in the NFC memory.</li>
<li>The application firmware code driving this behavior can be found at:<ul>
<li><code>Execute</code> (<code>maintlogger.c</code>) <br />
 The notification that an NFC write by the tag reader is completed is stored in the variable <code>sTargetWritten</code> and checked in <code>Execute</code>. There the NDEFT2T module is used to retrieve the data using <a class="el" href="a00479.html#ga86e2733b30f43d68effad331fcb993c1">NDEFT2T_GetMessage</a> and <a class="el" href="a00479.html#ga6a3a42026d8354639b9de950f8dd6138">NDEFT2T_GetNextRecord</a>, which is then fed to the <em>msg</em> module using <a class="el" href="a00477.html#ga2552889049504ea89cf998184171e290">Msg_HandleCommand</a>. The <em>msg</em> module guarantees the creation of one response, which is subsequently given to <code>ResponseCb</code> (<code>msghandler.c</code>), where the response will be wrapped in a MIME record in an NDEF message.</li>
<li><a class="el" href="a00490.html#gab6cd3b0573bb228d0bbf54c65068e746">AppMsgInit</a> <br />
 When this function is called two commands with message IDs <a class="el" href="a00477.html#ggade7075e3d56378af75d2c2dd4110ddd7acf2027afe00dc0d127e562519f67fc5e">MSG_ID_GETVERSION</a> and <a class="el" href="a00477.html#ggade7075e3d56378af75d2c2dd4110ddd7a980715d23a96a03e1da157040b961f76">MSG_ID_GETNFCUID</a> will be generated. Both commands are fed to the <em>msg</em> module and their responses stored in SRAM in <code>ResponseCb</code>.</li>
<li><code>GenerateNextAutomaticCommand</code> (<code>maintlogger.c</code>)<ul>
<li>After calling <a class="el" href="a00490.html#gab6cd3b0573bb228d0bbf54c65068e746">AppMsgInit</a>, <a class="el" href="a00479.html#ga7534ae047d7e38cb6d59d848753df6eb">NDEFT2T_EnableAutomaticMode</a> is called, followed by the generation of the first 'automatic command' in <code>GenerateNextAutomaticCommand</code>. The first command generated this way has <a class="el" href="a00491.html#ggaaac9c56961755fb862e21432c9425640a2b3cd31ed54361a1eaec43b49d537058">APP_MSG_ID_GETCONFIG</a> as message ID. When the <em>Get Config</em> response arrives in <code>ResponseCb</code>, the two stored responses with message IDs <a class="el" href="a00477.html#ggade7075e3d56378af75d2c2dd4110ddd7acf2027afe00dc0d127e562519f67fc5e">MSG_ID_GETVERSION</a> and <a class="el" href="a00477.html#ggade7075e3d56378af75d2c2dd4110ddd7a980715d23a96a03e1da157040b961f76">MSG_ID_GETNFCUID</a> are joined together in the same NDEF message - but in different MIME records - and the output of <a class="el" href="a00493.html#gab0172c1ba8aafdcad1517a2569ac65f8">Text_GetStatus</a>, <a class="el" href="a00493.html#ga12c3e22bf39f1ea7d6146f63c8d097eb">Text_GetFailures</a> and <a class="el" href="a00493.html#ga54140476b3f85e379d043edff16c9578">Text_GetTemperature</a> is used to add one or more text record in that same message.<br />
 The collection of all these records forms the initial NDEF message. This is the data that, at startup, must be copied fast enough by the ARM to the NFC memory to ensure a correct detection by the corresponding Android APP. It is sufficient to reset the 'automatic command' sequence - using <code>sResetAutomaticCommandGeneration</code> - and to subsequently call <code>GenerateNextAutomaticCommand</code> to re-generate this initial NDEF message.</li>
<li>Each time the tag reader reads out the NFC memory, the NDEFT2T module notifies the application. That notification is stored in <code>sMessageRead</code>, and checked in <code>Execute</code> which then triggers a new call to <code>GenerateNextAutomaticCommand</code>. This sequence is continually executed until one NFC write action of the tag reader is detected by the NFC controller.</li>
</ul>
</li>
</ul>
</li>
</ul>
</dd></dl>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="groups"></a>
Modules</h2></td></tr>
<tr class="memitem:a00488"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00488.html">Event Tags</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a00417"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00417.html">Measurement and event validation</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a00489"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00489.html">Memory block</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a00490"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00490.html">Message Handler block</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a00493"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00493.html">Stringifier</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a00492"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00492.html">Temperature block</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a00494"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00494.html">Use-case specific timers</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Oct 20 2020 08:24:34 for NHS31xx SW API by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
