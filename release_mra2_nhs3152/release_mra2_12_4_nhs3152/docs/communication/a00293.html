<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NHS31xx msg - Message Handler Protocol: Tag reader</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nxp-logo_small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NHS31xx msg - Message Handler Protocol
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('a00293.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Tag reader </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="msg_tagreader_introduction"></a>
Introduction</h1>
<p>A tag reader can both read and write to the tag. During production, the NFC controller of every NHS31xx IC is configured such that access to the communication interface of the firmware is never blocked. To ensure correct bi-directional communication, the tag reader needs to adhere to several standards and protocols:</p><ul>
<li>ISO/IEC 14443 - <em>Identification cards &ndash; Contactless integrated circuit cards &ndash; Proximity cards</em> and specifically part 4: <em>Transmission protocol</em>.</li>
<li>the NFC Data Exchange Format (NDEF) Technical Specification from NFC Forum</li>
<li>the <a class="el" href="a00187.html">msg</a> protocol.</li>
</ul>
<p>Specific information to enable communication to any NHS31xx IC is detailed out below. Sufficient knowledge of the NFC-forum standards and the <em>msg</em> protocol is assumed.</p>
<dl class="section note"><dt>Note</dt><dd>This page describes low-level information to get you started, so you can implement every layer yourself. Depending on the library and API at your disposal on your host platform, this may already have been done for you. For example, on an Android platform, high level API is already present so you can just focus on the <em>msg</em> protocol only.</dd></dl>
<h1><a class="anchor" id="msg_tagreader_mifare"></a>
Writing to and reading from the NFC memory</h1>
<p>The NFC controller in the NHS31xx ICs is fully compatible with a MIFARE UltraLight EV1 IC. It thus adheres to the ISO/IEC 14443 Type A standard for contactless smart cards. <br />
 All available MIFARE Ultralight EV1 commands can be found in the datasheet <a href="https://www.nxp.com/docs/en/data-sheet/MF0ULX1.pdf">MF0ULX1 <em>MIFARE Ultralight EV1 - Contactless ticket IC</em></a>, Rev. 3.3 - 9 April 2019, chapter 9, table 9. Once a tag has been selected, an application can perform full communication with only a limited set of them:</p>
<ul>
<li><code>GET_VERSION</code> is a MIFARE family specific command, and is used to identify the type of the IC. <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Name  </th><th class="markdownTableHeadCenter">Code  </th><th class="markdownTableHeadLeft">Description  </th><th class="markdownTableHeadLeft">Length   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Cmd  </td><td class="markdownTableBodyCenter"><code>60</code>  </td><td class="markdownTableBodyLeft">Get product version  </td><td class="markdownTableBodyLeft">1 byte   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">CRC  </td><td class="markdownTableBodyCenter"><code>xx</code>  </td><td class="markdownTableBodyLeft">See ISO/IEC 14443-3  </td><td class="markdownTableBodyLeft">2 bytes   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Data  </td><td class="markdownTableBodyCenter"></td><td class="markdownTableBodyLeft">Response  </td><td class="markdownTableBodyLeft">8 bytes   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">NAK  </td><td class="markdownTableBodyCenter"><code>0A</code>  </td><td class="markdownTableBodyLeft">Upon success  </td><td class="markdownTableBodyLeft">4 bits   </td></tr>
</table>
<ul>
<li>See also UM10876 <em>NHS31xx User manual</em>, Rev. 2.07 - 2 May 2019, subsection 11.6.2.1 <em>Device specific GET_VERSION command</em>, Table 105 <em>GET_VERSION response for NHS devices</em>.</li>
<li>The CRC is automatically added by mobile platforms Android and iOS.</li>
<li>A list of all possible <em>NAK</em> values can be found in the MF0ULX1 datasheet: 9.3 <em>MIFARE Ultralight ACK and NAK</em>, Table 10. <em>ACK and NAK values</em></li>
</ul>
<br />
 <br />
</li>
<li><code>READ</code> returns the bytes of 4 pages. <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Name  </th><th class="markdownTableHeadCenter">Code  </th><th class="markdownTableHeadLeft">Description  </th><th class="markdownTableHeadLeft">Length   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Cmd  </td><td class="markdownTableBodyCenter"><code>30</code>  </td><td class="markdownTableBodyLeft">Read 4 pages  </td><td class="markdownTableBodyLeft">1 byte   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Addr  </td><td class="markdownTableBodyCenter"><code>xx</code>  </td><td class="markdownTableBodyLeft">Start page address  </td><td class="markdownTableBodyLeft">1 byte   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">CRC  </td><td class="markdownTableBodyCenter"><code>yy</code>  </td><td class="markdownTableBodyLeft">See ISO/IEC 14443-3  </td><td class="markdownTableBodyLeft">2 bytes   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Data  </td><td class="markdownTableBodyCenter"></td><td class="markdownTableBodyLeft">Response  </td><td class="markdownTableBodyLeft">16 bytes   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">NAK  </td><td class="markdownTableBodyCenter"><code>0A</code>  </td><td class="markdownTableBodyLeft">Upon success  </td><td class="markdownTableBodyLeft">4 bits   </td></tr>
</table>
For example, when <em>Addr</em> equals <code>03h</code>, the bytes of pages <code>03h</code>, <code>04h</code>, <code>05h</code>, <code>06h</code> are returned. <br />
 <br />
</li>
<li><code>FAST_READ</code> returns the bytes of any number of pages. <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Name  </th><th class="markdownTableHeadCenter">Code  </th><th class="markdownTableHeadLeft">Description  </th><th class="markdownTableHeadLeft">Length   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Cmd  </td><td class="markdownTableBodyCenter"><code>3A</code>  </td><td class="markdownTableBodyLeft">Read multiple pages  </td><td class="markdownTableBodyLeft">1 byte   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">StartAddr  </td><td class="markdownTableBodyCenter"><code>xx</code>  </td><td class="markdownTableBodyLeft">Start page address  </td><td class="markdownTableBodyLeft">1 byte   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">EndAddr  </td><td class="markdownTableBodyCenter"><code>yy</code>  </td><td class="markdownTableBodyLeft">End page address  </td><td class="markdownTableBodyLeft">1 byte   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">CRC  </td><td class="markdownTableBodyCenter"><code>zz</code>  </td><td class="markdownTableBodyLeft">See ISO/IEC 14443-3  </td><td class="markdownTableBodyLeft">2 bytes   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Data  </td><td class="markdownTableBodyCenter"></td><td class="markdownTableBodyLeft">Response  </td><td class="markdownTableBodyLeft"><code>(yy-xx+1)*4</code> bytes   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">NAK  </td><td class="markdownTableBodyCenter"><code>0A</code>  </td><td class="markdownTableBodyLeft">Upon success  </td><td class="markdownTableBodyLeft">4 bits   </td></tr>
</table>
For example, when <em>StartAddr</em> equals <code>03h</code> and <em>EndAddr</em> equals <code>07h</code>, the bytes of pages <code>03h</code>, <code>04h</code>, <code>05h</code>, <code>06h</code>, <code>07h</code> are returned. <br />
 <br />
</li>
<li><code>WRITE</code> stores 4 bytes of data into a single page. <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Name  </th><th class="markdownTableHeadCenter">Code  </th><th class="markdownTableHeadLeft">Description  </th><th class="markdownTableHeadLeft">Length   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Cmd  </td><td class="markdownTableBodyCenter"><code>A2</code>  </td><td class="markdownTableBodyLeft">Write 1 page  </td><td class="markdownTableBodyLeft">1 byte   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Addr  </td><td class="markdownTableBodyCenter"><code>xx</code>  </td><td class="markdownTableBodyLeft">Page address  </td><td class="markdownTableBodyLeft">1 byte   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">CRC  </td><td class="markdownTableBodyCenter"><code>yy</code>  </td><td class="markdownTableBodyLeft">See ISO/IEC 14443-3  </td><td class="markdownTableBodyLeft">2 bytes   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Data  </td><td class="markdownTableBodyCenter"></td><td class="markdownTableBodyLeft">Data  </td><td class="markdownTableBodyLeft">4 bytes   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">NAK  </td><td class="markdownTableBodyCenter"><code>0A</code>  </td><td class="markdownTableBodyLeft">Upon success  </td><td class="markdownTableBodyLeft">4 bits   </td></tr>
</table>
<br />
</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>As part of the selection procedure before a tag is selected, the NFC ID is exchanged with the tag reader. To explicitly re-retrieve the same information as APDU command <code>GET UID</code>, use the tag-specific <code>READ</code> command to read the first 4 pages. The 7-byte NFC ID is stored in the first two pages, with byte 3 of page <code>00h</code> the first check byte (and byte 0 of page <code>02h</code> the second check byte).</dd></dl>
<h1><a class="anchor" id="msg_tagreader_apdu"></a>
Using USB NFC readers</h1>
<p>USB NFC readers implement the <em>Personal Computer/Smart Card</em> PC/SC specification to allow access to a tag. The specification is called the <em>The Interoperability Specification for ICCs and Personal Computer Systems</em> and is available at <a href="https://www.pcscworkgroup.com">https://www.pcscworkgroup.com</a>. The driver for a USB NFC reader allows communication to a tag by means of <em>smart card application protocol data unit</em>s or APDU's. An applications sends a <em>command</em> APDU and receives back a <em>response</em> APDU. The USB NFC reader will translate the APDU's to the tag specific commands and responses, regardless of NFC type and manufacturer. <b>Always check the User Manual of your USB NFC reader.</b> <br />
 <br />
 Once connected, an application can perform full communication with a limited set of commands:</p>
<ul>
<li><code>GET UID</code> command APDU will retrieve the NFC ID, which is a <em>random</em> 7-byte sequence determined during production of the IC. <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">CLA  </th><th class="markdownTableHeadCenter">INS  </th><th class="markdownTableHeadCenter">P1  </th><th class="markdownTableHeadCenter">P2  </th><th class="markdownTableHeadCenter">Lc  </th><th class="markdownTableHeadCenter">Data  </th><th class="markdownTableHeadCenter">Le   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><code>FF</code>  </td><td class="markdownTableBodyCenter"><code>CA</code>  </td><td class="markdownTableBodyCenter"><code>00</code>  </td><td class="markdownTableBodyCenter"><code>00</code>  </td><td class="markdownTableBodyCenter">absent  </td><td class="markdownTableBodyCenter">absent  </td><td class="markdownTableBodyCenter"><code>07</code>   </td></tr>
</table>
<br />
 Upon success, the response APDU will be: <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Data  </th><th class="markdownTableHeadCenter">SW1  </th><th class="markdownTableHeadCenter">SW2   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">7 bytes  </td><td class="markdownTableBodyCenter"><code>90</code>  </td><td class="markdownTableBodyCenter"><code>00</code>   </td></tr>
</table>
<ul>
<li>A list of all possible <em>NAK</em> values can be found in <a href="http://pcscworkgroup.com/Download/Specifications/pcsc3_v2.01.09.pdf">Part 3 <em>Requirements for PC-Connected Interface Devices</em></a> of the specification, Revision 2.01.09 - June 2007, subsection 3.2.2.1.3 <em>Get Data Command</em>, Table 3-9: <em>GET DATA Error Codes</em>.</li>
</ul>
<br />
</li>
<li><code>READ BINARY</code> reads data from a MIFARE card. Data is read per 4 pages. <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">CLA  </th><th class="markdownTableHeadCenter">INS  </th><th class="markdownTableHeadCenter">P1  </th><th class="markdownTableHeadCenter">P2  </th><th class="markdownTableHeadCenter">Lc  </th><th class="markdownTableHeadCenter">Data  </th><th class="markdownTableHeadCenter">Le   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><code>FF</code>  </td><td class="markdownTableBodyCenter"><code>B0</code>  </td><td class="markdownTableBodyCenter">MSB  </td><td class="markdownTableBodyCenter">LSB  </td><td class="markdownTableBodyCenter">absent  </td><td class="markdownTableBodyCenter">absent  </td><td class="markdownTableBodyCenter"><code>10</code>   </td></tr>
</table>
P1 and P2 combined represent the starting page number to be read. <br />
 <br />
 Upon success, the response APDU will be: <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Data  </th><th class="markdownTableHeadCenter">SW1  </th><th class="markdownTableHeadCenter">SW2   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">16 bytes  </td><td class="markdownTableBodyCenter"><code>90</code>  </td><td class="markdownTableBodyCenter"><code>00</code>   </td></tr>
</table>
<ul>
<li>Depending on the driver implementation on your host platform, it may be that only 4 bytes are returned, even though 16 bytes have been fetched.</li>
<li>If <em>Le</em> is set to <code>00h</code>, the tag reader will repeatedly read data from the tag up to a maximum of 256 and return all bytes at once.</li>
<li>A list of all possible <em>NAK</em> values can be found in Part 3 of the specification, subsection 3.2.2.1.8 <em>Read Binary Command</em>, Table 3-19: <em>Read Binary Command Error Codes</em>.</li>
</ul>
<br />
</li>
<li><code>UPDATE BINARY</code> writes a single page. <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">CLA  </th><th class="markdownTableHeadCenter">INS  </th><th class="markdownTableHeadCenter">P1  </th><th class="markdownTableHeadCenter">P2  </th><th class="markdownTableHeadCenter">Lc  </th><th class="markdownTableHeadCenter">Data  </th><th class="markdownTableHeadCenter">Le   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><code>FF</code>  </td><td class="markdownTableBodyCenter"><code>D6</code>  </td><td class="markdownTableBodyCenter">MSB  </td><td class="markdownTableBodyCenter">LSB  </td><td class="markdownTableBodyCenter">04  </td><td class="markdownTableBodyCenter">4 bytes  </td><td class="markdownTableBodyCenter">absent   </td></tr>
</table>
P1 and P2 combined represent the page number to be written. <br />
 When writing more than 4 bytes, multiple pages need to be written. This command will then need to be repeated for every page. <br />
 <br />
 The response APDU only contains the status bytes. Upon success these will be: <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Data  </th><th class="markdownTableHeadCenter">SW1  </th><th class="markdownTableHeadCenter">SW2   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">absent  </td><td class="markdownTableBodyCenter"><code>90</code>  </td><td class="markdownTableBodyCenter"><code>00</code>   </td></tr>
</table>
<ul>
<li>A list of all possible <em>NAK</em> values can be found in Part 3 of the specification, subsection 3.2.2.1.9 <em>Update Binary Command</em>, Table 3-21: <em>Update Binary Command Error Codes </em>.</li>
</ul>
</li>
</ul>
<p>More information about APDUs can be found:</p><ul>
<li>with the documentation of your USB NFC reader.</li>
<li>in the specification, specifically <em>Part 3. Requirements for PC-Connected Interface Devices</em></li>
<li>in ISO/IEC 7816 and specifically part 4: <em>Organization, security and commands for interchange</em>.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>It is not possible to retrieve the same information as the tag-specific <code>GET_VERSION</code> MIFARE command using an APDU command.</dd></dl>
<h1><a class="anchor" id="msg_tagreader_ndef"></a>
NDEF</h1>
<dl class="section user"><dt>Write location</dt><dd>The NFC memory is organized in pages with 4 bytes per page. The writable portion of the type2 tag NFC memory starts at page <code>04h</code>. It is the task of the embedded firmware to initialize the NFC contents. This must be done before the tag reader starts reading the NFC contents. Failure to do so in time will result in the tag being reported as an <em>NDEF formattable</em> tag, which carries some restrictions when the tag reader wants to use the high level API, available on platforms as Android and iOS. <br />
 The SDK supports you with this through the <em>ndeft2t</em> module. Initialize the module at startup in your firmware and the NFC contents will be populated with:<ul>
<li>a lock TLV: <code>01 03 E8 0E 46</code>,</li>
<li>a proprietary TLV: <code>FD 01 00</code> and</li>
<li>an empty NDEF TLV: <code>03 00</code>.</li>
</ul>
The tag reader must know which pages are locked and thus read-only. The read-only third page <code>02h</code> contains locking bits, covering the pages up to <code>0Fh</code>. Similar information for higher pages can be retrieved using the extra lock TLV starting at page <code>04h</code>. <br />
 The proprietary TLV is present for padding purposes: with it, the next TLV - the NDEF message - will start on a page boundary. This allows the <em>ndeft2t</em> module to correctly detect when new messages arrive, and when outgoing messages have been consumed by the tag reader.</dd></dl>
<p>When the tag reader reads the NFC contents, the NDEF message will be present on page 6 onwards.</p><ul>
<li>All new NDEF messages written by the ARM firmware application will overwrite the contents on page 6 onwards;</li>
<li>all NDEF messages written by the tag reader must also overwrite the contents on page 6 onwards.</li>
<li>The lock TLV and proprietary TLV on page 4 and 5 must be kept intact.</li>
</ul>
<dl class="section user"><dt>Write sequence</dt><dd>To be compliant with the NFC forum specification, an NDEF message must be written in a 4-step process:<ol type="1">
<li>Write an NDEF message with length 0</li>
<li>Write the payload</li>
<li>Update the length</li>
<li>Write the end demarcation: the terminator TLV <code>FE</code> </li>
</ol>
Step 4 may be omitted or combined with step 2 (in practice, not according to a strict interpretation of the NFC forum specification). The <em>ndeft2t</em> module will also follow this process when writing an NDEF message for the tag reader to consume, writing the end demarcation together with the rest of the payload (combining step 2 and 4). The end demarcation is always written by the <em>ndeft2t</em> module, but not looked at when parsing. Steps 1 through 3 must be adhered to or the <em>ndeft2t</em> module will fail to detect new messages, or fail to parse them correctly - for example as it may be too fast and start parsing before all contents are already available. </dd></dl>
<dl class="section user"><dt>Compatibility</dt><dd>Compatibility with the NDEF messaging format is provided again by the <em>ndeft2t</em> module in the SDK. There are a few limitations in the implementation:<ul>
<li>Only a single NDEF message is supported.</li>
<li>Only TEXT, URL, MIME and AAR records are supported.</li>
<li>Only UTF-8 TEXT is supported.</li>
<li>Only the most probable URI prefixes are supported when using the shortened format.</li>
</ul>
The firmware may write and can parse multi-record NDEF messages, with any of its supported record types in any order. <br />
 The most used container to convey information is the MIME record. Currently, the mime type is not used by the firmware when interpreting the different payloads, but your custom application can. The minimum length of a mime type is 3 and must include a slash <code>"/"</code>. All host demo apps use therefore the mimetype <code>"n/p"</code>, while the demo firmware applications use a custom mimetype which identifies the demo at hand. This can be used by the host app to help determining whether the correct tag was tapped.</dd></dl>
<h1><a class="anchor" id="msg_tagreader_msg"></a>
Example</h1>
<ul>
<li>To retrieve firmware version information, the msg protocol provides <a class="el" href="a00187.html#ggade7075e3d56378af75d2c2dd4110ddd7acf2027afe00dc0d127e562519f67fc5e">MSG_ID_GETVERSION</a>. <br />
 The command does not contain any parameters, so the full command to write is <code>02 00</code> <br />
 <br />
</li>
<li>A MIME record contains these fields: <div class="fragment"><div class="line">MB|ME|CF|SR|IL|TNF   type_length   payload_length   type       payload</div></div><!-- fragment --> When only a simple single NDEF record is to be created, this can translate to: <div class="fragment"><div class="line">1 |1 |0 |1 |0 |2      3            payload_length   <span class="stringliteral">&quot;n/p&quot;</span>      payload</div></div><!-- fragment --> In hexadecimal format, this equals: <div class="fragment"><div class="line">D2                   03            payload_length   6E 2F 70   payload</div></div><!-- fragment --> And when trying to retrieve version information, this then becomes: <div class="fragment"><div class="line">D2                   03            02               6E 2F 70   02 00</div></div><!-- fragment --> <br />
</li>
<li>An NDEF message is a <code>TLV</code> with<ul>
<li><code>Type</code> equal to <code>03</code>. The type is always a single byte.</li>
<li><code>Length</code> equal to the number of bytes that will follow. If that number is strict less than <code>0xFF</code>, <code>Length</code> is just a single byte; else, the length is encoded as<div class="fragment"><div class="line">FF MSB LSB </div></div><!-- fragment --></li>
<li><code>Value</code> equal to the bytes of all the record payloads, placed right after each other.</li>
</ul>
In this example, the full TLV byte sequence is then <div class="fragment"><div class="line">T    L    V</div><div class="line">T    L    D2   03   02   6E 2F 70   02 00</div><div class="line">03   08   D2   03   02   6E 2F 70   02 00</div></div><!-- fragment --> <br />
</li>
<li>With the end demarcation <code>FE</code> appended this will occupy three pages. After writing these, the contents of the NFC memory must become: <div class="fragment"><div class="line">page 06h: 03 08 D2 03</div><div class="line">page 07h: 02 6E 2F 70</div><div class="line">page 08h: 02 00 FE xx</div></div><!-- fragment --> The last byte of page 8 <code>xx</code> can contain anything and will never be looked at. <br />
 <br />
</li>
<li>To write this, per the NFC forum specification, these 5 write commands must be carried out in this order: <div class="fragment"><div class="line">page 06h: 03 00 xx xx</div><div class="line">page 07h: 02 6E 2F 70</div><div class="line">page 08h: 02 00 xx xx</div><div class="line">page 06h: 03 08 D2 03</div><div class="line">page 08h: 02 00 FE xx</div></div><!-- fragment --> The bytes denoting <code>xx</code> can have any value. <br />
 Usually, the end demarcation <code>FE</code> is written together with the payload (combining step 4 with step 2): <div class="fragment"><div class="line">page 06h: 03 00 00 00</div><div class="line">page 07h: 02 6E 2F 70</div><div class="line">page 08h: 02 00 FE 00</div><div class="line">page 06h: 03 08 D2 03</div></div><!-- fragment --> A total of 4 page write commands then need to be executed. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Oct 20 2020 08:24:35 for NHS31xx msg - Message Handler Protocol by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
